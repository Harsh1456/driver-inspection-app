{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Inspection Processor{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-start">
        <div>
            <a href="{{ url_for('dashboard.dashboard') }}" class="text-green-600 hover:text-green-700 mb-4 inline-block">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
            <h1 class="text-3xl font-bold text-gray-800">{{ file.file_name }}</h1>
            <p class="text-gray-600">Uploaded on {{ file.upload_timestamp.strftime('%B %d, %Y at %I:%M %p') }}</p>
        </div>
        <button onclick="deleteFile('{{ file.file_id }}')" 
                class="bg-red-600 text-white px-6 py-3 rounded-xl font-medium hover:bg-red-700 transition-all flex items-center">
            <i class="fas fa-trash mr-2"></i>Delete This File
        </button>
    </div>
</div>

<!-- Rest of your existing file_detail.html content remains exactly the same -->
<!-- File Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center">
        <p class="text-gray-500 text-sm">Total Pages</p>
        <p class="text-2xl font-bold text-gray-800">{{ file.total_pages }}</p>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center">
        <p class="text-gray-500 text-sm">With Remarks</p>
        <p class="text-2xl font-bold text-orange-600">{{ file.pages_with_remarks }}</p>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center">
        <p class="text-gray-500 text-sm">Without Remarks</p>
        <p class="text-2xl font-bold text-green-600">{{ file.pages_without_remarks }}</p>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center">
        <p class="text-gray-500 text-sm">Criticality</p>
        <p class="text-2xl font-bold {{ 'text-red-600' if file.criticality_level == 'RED' else 'text-orange-600' if file.criticality_level == 'ORANGE' else 'text-green-600' }}">
            {{ file.criticality_level }}
        </p>
    </div>
</div>

<!-- Main Gallery View -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-800">Document Viewer</h2>
        <p class="text-sm text-gray-600">Page <span id="current-page">1</span> of {{ pages|length }}</p>
    </div>
    
    <!-- Current Page View -->
    <div class="p-6">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-medium text-gray-800" id="current-page-title">Page 1</h3>
            <span id="current-page-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
                Has Remarks
            </span>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Page Image Section with Controls -->
            <div class="space-y-4">
                <h4 class="text-sm font-medium text-gray-700">Page Image</h4>
                <div class="border border-gray-200 rounded-lg bg-gray-50">
                    <!-- Main Image with Navigation Arrows -->
                    <div class="relative p-4">
                        <!-- Navigation Arrows -->
                        <button id="prev-page" class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition disabled:opacity-30 disabled:cursor-not-allowed z-10">
                            <i class="fas fa-chevron-left w-4 h-4"></i>
                        </button>
                        
                        <button id="next-page" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition disabled:opacity-30 disabled:cursor-not-allowed z-10">
                            <i class="fas fa-chevron-right w-4 h-4"></i>
                        </button>
                        
                        <!-- Main Image -->
                        <div class="flex justify-center">
                            <img id="current-page-image" 
                                 src="{{ url_for('serve_image', file_id=file.file_id, page_number=1) }}" 
                                 alt="Page 1" 
                                 class="max-w-full max-h-80 object-contain rounded shadow-sm cursor-pointer"
                                 onclick="openImageModal(this.src)">
                        </div>
                    </div>
                    
                    <!-- Filmstrip Gallery -->
                    <div class="border-t border-gray-200 p-3 bg-white">
                        <div class="flex space-x-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                            {% for page in pages %}
                            <div class="flex-shrink-0 w-16 cursor-pointer transition-all duration-200 hover:scale-105" onclick="showPage({{ page.page_number }})">
                                <div class="border border-gray-300 rounded p-1 bg-white page-thumbnail {% if page.page_number == 1 %}border-green-500 bg-green-50{% endif %}" id="thumb-{{ page.page_number }}">
                                    <img src="{{ url_for('serve_image', file_id=file.file_id, page_number=page.page_number) }}" 
                                         alt="Page {{ page.page_number }}" 
                                         class="w-full h-12 object-cover rounded">
                                    <div class="mt-1 text-center">
                                        <span class="text-xs font-medium text-gray-700">{{ page.page_number }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Quick Navigation -->
                    <div class="border-t border-gray-200 px-3 py-2 bg-gray-50 flex justify-between items-center">
                        <button onclick="jumpToPage(1)" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-fast-backward mr-1"></i>First
                        </button>
                        <span class="text-xs text-gray-500">Click thumbnails or use arrows</span>
                        <button onclick="jumpToPage({{ pages|length }})" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                            Last<i class="fas fa-fast-forward ml-1"></i>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 text-center">Click image to view full size</p>
            </div>
            
            <!-- Extracted Text -->
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Extracted Text</h4>
                <div class="border border-gray-200 rounded-lg h-96 flex flex-col">
                    <textarea id="current-page-text" 
                            class="w-full h-full p-3 text-sm border-0 focus:ring-1 focus:ring-green-500 rounded-lg resize-none"
                            placeholder="No text extracted"></textarea>
                    <div class="px-3 py-2 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                        <span id="current-page-confidence" class="text-xs text-gray-500">
                            Confidence: 0%
                        </span>
                        <button onclick="updateCurrentPageText()" 
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-full">
        <button onclick="closeImageModal()" class="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300 z-10">
            <i class="fas fa-times"></i>
        </button>
        <div class="overflow-auto max-h-screen">
            <img id="modalImage" src="" alt="Full size image" class="max-w-full max-h-full object-contain">
        </div>
    </div>
</div>

<!-- Store page data in JavaScript -->
<script>
const pagesData = {
    {% for page in pages %}
    {{ page.page_number }}: {
        page_id: '{{ page.page_id }}',
        has_remarks: {{ 'true' if page.has_remarks else 'false' }},
        extracted_text: {{ page.extracted_text|tojson }},
        confidence_score: {{ page.confidence_score or 0 }},
        image_url: "{{ url_for('serve_image', file_id=file.file_id, page_number=page.page_number) }}"
    },
    {% endfor %}
};
</script>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
const totalPages = {{ pages|length }};

function showPage(pageNumber) {
    if (pageNumber < 1 || pageNumber > totalPages) return;
    
    currentPage = pageNumber;
    const pageData = pagesData[pageNumber];
    
    // Update main display
    document.getElementById('current-page').textContent = pageNumber;
    document.getElementById('current-page-title').textContent = `Page ${pageNumber}`;
    document.getElementById('current-page-image').src = pageData.image_url;
    document.getElementById('current-page-image').alt = `Page ${pageNumber}`;
    document.getElementById('current-page-text').value = pageData.extracted_text || '';
    document.getElementById('current-page-confidence').textContent = `Confidence: ${(pageData.confidence_score * 100).toFixed(1)}%`;
    
    // Update status badge
    const statusElement = document.getElementById('current-page-status');
    if (pageData.has_remarks) {
        statusElement.textContent = 'Has Remarks';
        statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800';
        document.getElementById('current-page-text').disabled = false;
    } else {
        statusElement.textContent = 'No Remarks';
        statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
        document.getElementById('current-page-text').disabled = true;
        document.getElementById('current-page-text').value = 'No handwritten remarks detected on this page';
    }
    
    // Update thumbnails
    document.querySelectorAll('.page-thumbnail').forEach(thumb => {
        thumb.classList.remove('border-green-500', 'bg-green-50');
    });
    document.getElementById(`thumb-${pageNumber}`).classList.add('border-green-500', 'bg-green-50');
    
    // Update navigation buttons
    document.getElementById('prev-page').disabled = pageNumber === 1;
    document.getElementById('next-page').disabled = pageNumber === totalPages;
}

function updateCurrentPageText() {
    const pageData = pagesData[currentPage];
    const textarea = document.getElementById('current-page-text');
    const text = textarea.value;
    
    // Don't save if it's the default "no remarks" text
    if (!pageData.has_remarks && text === 'No handwritten remarks detected on this page') {
        return;
    }
    
    fetch(`/api/page/${pageData.page_id}/update-text`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: text })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Text updated successfully', 'success');
            // Update local data
            pagesData[currentPage].extracted_text = text;
        } else {
            showNotification('Error updating text: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Error updating text: ' + error.message, 'error');
    });
}

function jumpToPage(pageNumber) {
    showPage(pageNumber);
    // Scroll filmstrip to show the selected page
    const thumbElement = document.getElementById(`thumb-${pageNumber}`).parentElement;
    if (thumbElement) {
        thumbElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
}

function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file and all its images? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/file/${fileId}/delete`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('File and images deleted successfully', 'success');
            setTimeout(() => {
                window.location.href = "{{ url_for('dashboard.dashboard') }}";
            }, 1000);
        } else {
            showNotification('Error deleting file: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Error deleting file: ' + error.message, 'error');
    });
}

// Navigation event listeners
document.getElementById('prev-page').addEventListener('click', () => showPage(currentPage - 1));
document.getElementById('next-page').addEventListener('click', () => showPage(currentPage + 1));

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
        showPage(currentPage - 1);
    } else if (e.key === 'ArrowRight') {
        showPage(currentPage + 1);
    }
});

// Modal functions
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Close modal on background click or Escape key
document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target.id === 'imageModal') {
        closeImageModal();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('imageModal').classList.contains('hidden')) {
        closeImageModal();
    }
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
    } z-50`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Initialize the first page
showPage(1);
</script>

<style>
.scrollbar-thin::-webkit-scrollbar {
    height: 4px;
}

.scrollbar-thin::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 2px;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.page-thumbnail {
    transition: all 0.2s ease-in-out;
}
</style>
{% endblock %}