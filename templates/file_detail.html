{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Inspection Processor{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-start">
        <div>
            <a href="{{ url_for('dashboard.dashboard') }}"
                class="text-green-600 hover:text-green-700 mb-4 inline-block">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
            <h1 class="text-3xl font-bold text-gray-800">{{ file.file_name }}</h1>
            <p class="text-gray-600">Uploaded on {{ file.upload_timestamp.strftime('%B %d, %Y at %I:%M %p') }}</p>
        </div>
        <div class="flex space-x-2">
            <button onclick="openEditModal()"
                class="bg-indigo-600 text-white px-4 py-3 rounded-xl font-medium hover:bg-indigo-700 transition-all flex items-center">
                <i class="fas fa-edit mr-2"></i>Edit Report
            </button>
            <button onclick="exportExcel()"
                class="bg-green-600 text-white px-4 py-3 rounded-xl font-medium hover:bg-green-700 transition-all flex items-center">
                <i class="fas fa-file-excel mr-2"></i>Export Excel
            </button>
            <button onclick="deleteFile('{{ file.file_id }}')"
                class="bg-red-600 text-white px-4 py-3 rounded-xl font-medium hover:bg-red-700 transition-all flex items-center">
                <i class="fas fa-trash mr-2"></i>Delete
            </button>
        </div>
    </div>
</div>

<!-- Rest of your existing file_detail.html content remains exactly the same -->
<!-- File Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div id="filter-all" onclick="filterPages('all')"
        class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center cursor-pointer hover:bg-gray-50 transition-all ring-2 ring-blue-500">
        <p class="text-gray-500 text-sm">Total Pages</p>
        <p class="text-2xl font-bold text-gray-800">{{ file.total_pages }}</p>
    </div>
    <div id="filter-with_remarks" onclick="filterPages('with_remarks')"
        class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center cursor-pointer hover:bg-gray-50 transition-all">
        <p class="text-gray-500 text-sm">With Remarks</p>
        <p class="text-2xl font-bold text-orange-600">{{ file.pages_with_remarks }}</p>
    </div>
    <div id="filter-without_remarks" onclick="filterPages('without_remarks')"
        class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center cursor-pointer hover:bg-gray-50 transition-all">
        <p class="text-gray-500 text-sm">Without Remarks</p>
        <p class="text-2xl font-bold text-green-600">{{ file.pages_without_remarks }}</p>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 text-center">
        <p class="text-gray-500 text-sm">Criticality</p>
        <p
            class="text-2xl font-bold {{ 'text-red-600' if file.criticality_level == 'RED' else 'text-orange-600' if file.criticality_level == 'ORANGE' else 'text-green-600' }}">
            {{ file.criticality_level }}
        </p>
    </div>
</div>

<!-- Main Gallery View -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-800">Document Viewer</h2>
        <p class="text-sm text-gray-600">Page <span id="current-page">1</span> of <span id="total-pages-count">{{
                pages|length }}</span></p>
    </div>

    <!-- Current Page View -->
    <div class="p-6">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-medium text-gray-800" id="current-page-title">Page 1</h3>
            <span id="current-page-status"
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
                Has Remarks
            </span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Page Image Section with Controls -->
            <div class="space-y-4">
                <h4 class="text-sm font-medium text-gray-700">Page Image</h4>
                <div class="border border-gray-200 rounded-lg bg-gray-50">
                    <!-- Main Image with Navigation Arrows -->
                    <div class="relative p-4">
                        <!-- Navigation Arrows -->
                        <button id="prev-page"
                            class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition disabled:opacity-30 disabled:cursor-not-allowed z-10">
                            <i class="fas fa-chevron-left w-4 h-4"></i>
                        </button>

                        <button id="next-page"
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition disabled:opacity-30 disabled:cursor-not-allowed z-10">
                            <i class="fas fa-chevron-right w-4 h-4"></i>
                        </button>

                        <!-- Main Image -->
                        <div class="flex justify-center">
                            <img id="current-page-image"
                                src="{{ url_for('serve_image', file_id=file.file_id, page_number=1) }}" alt="Page 1"
                                class="max-w-full max-h-80 object-contain rounded shadow-sm cursor-pointer"
                                onclick="openImageModal(this.src)">
                        </div>
                    </div>

                    <!-- Filmstrip Gallery -->
                    <div class="border-t border-gray-200 p-3 bg-white">
                        <div
                            class="flex space-x-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                            {% for page in pages %}
                            <div class="flex-shrink-0 w-16 cursor-pointer transition-all duration-200 hover:scale-105"
                                onclick="showPage({{ page.page_number }})">
                                <div class="border border-gray-300 rounded p-1 bg-white page-thumbnail {% if page.page_number == 1 %}border-green-500 bg-green-50{% endif %}"
                                    id="thumb-{{ page.page_number }}">
                                    <img src="{{ url_for('serve_image', file_id=file.file_id, page_number=page.page_number) }}"
                                        alt="Page {{ page.page_number }}" class="w-full h-12 object-cover rounded">
                                    <div class="mt-1 text-center">
                                        <span class="text-xs font-medium text-gray-700">{{ page.page_number }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Quick Navigation -->
                    <div class="border-t border-gray-200 px-3 py-2 bg-gray-50 flex justify-between items-center">
                        <button onclick="jumpToPage(1)" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-fast-backward mr-1"></i>First
                        </button>
                        <span class="text-xs text-gray-500">Click thumbnails or use arrows</span>
                        <button onclick="jumpToPage({{ pages|length }})"
                            class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                            Last<i class="fas fa-fast-forward ml-1"></i>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 text-center">Click image to view full size</p>
            </div>

            <!-- Extracted Text -->
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Extracted Text</h4>
                <div class="border border-gray-200 rounded-lg h-96 flex flex-col">
                    <textarea id="current-page-text"
                        class="w-full h-full p-3 text-sm border-0 focus:ring-1 focus:ring-green-500 rounded-lg resize-none"
                        placeholder="No text extracted"></textarea>
                    <div class="px-3 py-2 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                        <span id="current-page-confidence" class="text-xs text-gray-500">
                            Confidence: 0%
                        </span>
                        <button onclick="updateCurrentPageText()"
                            class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-full">
        <button onclick="closeImageModal()"
            class="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300 z-10">
            <i class="fas fa-times"></i>
        </button>
        <div class="overflow-auto max-h-screen">
            <img id="modalImage" src="" alt="Full size image" class="max-w-full max-h-full object-contain">
        </div>
    </div>
</div>

<!-- Store page data in JavaScript -->
<script>
    let pagesData = {
        {% for page in pages %}
        {{ page.page_number }}: {
            page_id: '{{ page.page_id }}',
            has_remarks: {{ 'true' if page.has_remarks else 'false' }},
            extracted_text: {{ page.extracted_text | tojson }},
            confidence_score: {{ page.confidence_score or 0 }},
            image_url: "{{ url_for('serve_image', file_id=file.file_id, page_number=page.page_number) }}"
        },
        {% endfor %}
    };
    let currentPagesList = Object.keys(pagesData).map(Number).sort((a, b) => a - b);
</script>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let totalPages = {{ pages|length }};

    function initializeArrowButtons() {
        // Set up initial event listeners for arrow buttons
        document.getElementById('prev-page').addEventListener('click', () => {
            const currentIndex = currentPagesList.indexOf(currentPage);
            if (currentIndex > 0) {
                showPage(currentPagesList[currentIndex - 1]);
            }
        });
        
        document.getElementById('next-page').addEventListener('click', () => {
            const currentIndex = currentPagesList.indexOf(currentPage);
            if (currentIndex < currentPagesList.length - 1) {
                showPage(currentPagesList[currentIndex + 1]);
            }
        });
    }

    function filterPages(filterType) {
        // Update UI active state
        document.querySelectorAll('[id^="filter-"]').forEach(el => {
            el.classList.remove('ring-2', 'ring-blue-500');
        });
        document.getElementById(`filter-${filterType}`).classList.add('ring-2', 'ring-blue-500');

        // Fetch filtered pages
        fetch(`/api/file/{{ file.file_id }}?filter=${filterType}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update pages data
                    pagesData = {};
                    data.pages.forEach(page => {
                        pagesData[page.page_number] = {
                            page_id: page.page_id,
                            has_remarks: page.has_remarks,
                            extracted_text: page.extracted_text,
                            confidence_score: page.confidence_score || 0,
                            image_url: `/image/{{ file.file_id }}/${page.page_number}`
                        };
                    });

                    currentPagesList = data.pages.map(p => p.page_number).sort((a, b) => a - b);
                    totalPages = currentPagesList.length;
                    document.getElementById('total-pages-count').textContent = totalPages;

                    // Re-render filmstrip
                    const filmstrip = document.querySelector('.overflow-x-auto');
                    filmstrip.innerHTML = '';

                    currentPagesList.forEach(pageNum => {
                        const page = pagesData[pageNum];
                        const div = document.createElement('div');
                        div.className = 'flex-shrink-0 w-16 cursor-pointer transition-all duration-200 hover:scale-105';
                        div.onclick = () => showPage(pageNum);
                        div.innerHTML = `
                        <div class="border border-gray-300 rounded p-1 bg-white page-thumbnail" id="thumb-${pageNum}">
                            <img src="${page.image_url}"
                                 alt="Page ${pageNum}"
                                 class="w-full h-12 object-cover rounded">
                            <div class="mt-1 text-center">
                                <span class="text-xs font-medium text-gray-700">${pageNum}</span>
                            </div>
                        </div>
                    `;
                        filmstrip.appendChild(div);
                    });

                    // Re-initialize arrow buttons after filtering
                    initializeArrowButtons();

                    // Show first page of filtered results
                    if (currentPagesList.length > 0) {
                        showPage(currentPagesList[0]);
                    } else {
                        // Handle empty state
                        document.getElementById('current-page-image').src = ''; // Or a placeholder
                        document.getElementById('current-page-image').alt = 'No pages found';
                        document.getElementById('current-page-text').value = '';
                        document.getElementById('current-page-status').textContent = '';
                        document.getElementById('current-page-status').className = 'hidden';
                    }
                }
            })
            .catch(error => console.error('Error filtering pages:', error));
    }

    function showPage(pageNumber) {
        if (!currentPagesList.includes(pageNumber)) return;

        currentPage = pageNumber;
        const pageData = pagesData[pageNumber];

        // Update main display
        document.getElementById('current-page').textContent = pageNumber; // Show actual page number
        document.getElementById('current-page-title').textContent = `Page ${pageNumber}`;
        document.getElementById('current-page-image').src = pageData.image_url;
        document.getElementById('current-page-image').alt = `Page ${pageNumber}`;
        document.getElementById('current-page-text').value = pageData.extracted_text || '';
        // Confidence score logic: Show 100% if no remarks, otherwise show actual score
        const confidence = pageData.has_remarks ? pageData.confidence_score : 1.0;
        document.getElementById('current-page-confidence').textContent = `Confidence: ${(confidence * 100).toFixed(1)}%`;

        // Update status badge
        const statusElement = document.getElementById('current-page-status');
        if (pageData.has_remarks) {
            statusElement.textContent = 'Has Remarks';
            statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800';
            document.getElementById('current-page-text').disabled = false;
        } else {
            statusElement.textContent = 'No Remarks';
            statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
            document.getElementById('current-page-text').disabled = true;
            document.getElementById('current-page-text').value = 'No handwritten remarks detected on this page';
        }

        // Update thumbnails
        document.querySelectorAll('.page-thumbnail').forEach(thumb => {
            thumb.classList.remove('border-green-500', 'bg-green-50');
        });
        document.getElementById(`thumb-${pageNumber}`).classList.add('border-green-500', 'bg-green-50');

        // Update navigation buttons state
        const currentIndex = currentPagesList.indexOf(currentPage);
        document.getElementById('prev-page').disabled = currentIndex <= 0;
        document.getElementById('next-page').disabled = currentIndex >= currentPagesList.length - 1;
    }

    function updateCurrentPageText() {
        const pageData = pagesData[currentPage];
        const textarea = document.getElementById('current-page-text');
        const text = textarea.value;

        // Don't save if it's the default "no remarks" text
        if (!pageData.has_remarks && text === 'No handwritten remarks detected on this page') {
            return;
        }

        fetch(`/api/page/${pageData.page_id}/update-text`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text: text })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Text updated successfully', 'success');
                    // Update local data
                    pagesData[currentPage].extracted_text = text;
                } else {
                    showNotification('Error updating text: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Error updating text: ' + error.message, 'error');
            });
    }

    function jumpToPage(pageNumber) {
        showPage(pageNumber);
        // Scroll filmstrip to show the selected page
        const thumbElement = document.getElementById(`thumb-${pageNumber}`).parentElement;
        if (thumbElement) {
            thumbElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    function deleteFile(fileId) {
        if (!confirm('Are you sure you want to delete this file and all its images? This action cannot be undone.')) {
            return;
        }

        fetch(`/api/file/${fileId}/delete`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('File and images deleted successfully', 'success');
                    setTimeout(() => {
                        window.location.href = "{{ url_for('dashboard.dashboard') }}";
                    }, 1000);
                } else {
                    showNotification('Error deleting file: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Error deleting file: ' + error.message, 'error');
            });
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        const currentIndex = currentPagesList.indexOf(currentPage);
        if (e.key === 'ArrowLeft') {
            if (currentIndex > 0) showPage(currentPagesList[currentIndex - 1]);
        } else if (e.key === 'ArrowRight') {
            if (currentIndex < currentPagesList.length - 1) showPage(currentPagesList[currentIndex + 1]);
        }
    });

    // Modal functions
    function openImageModal(src) {
        document.getElementById('modalImage').src = src;
        document.getElementById('imageModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        document.getElementById('imageModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Close modal on background click or Escape key
    document.getElementById('imageModal').addEventListener('click', function (e) {
        if (e.target.id === 'imageModal') {
            closeImageModal();
        }
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !document.getElementById('imageModal').classList.contains('hidden')) {
            closeImageModal();
        }
    });

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } z-50`;
        notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Initialize arrow button event listeners
    initializeArrowButtons();

    // Initialize the first page
    if (currentPagesList.length > 0) {
        showPage(currentPagesList[0]);
    }

    function exportExcel() {
        showNotification('Generating Excel export...', 'info');
        fetch('/api/export/excel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ file_ids: ['{{ file.file_id }}'] })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create download link for Excel
                    const linkSource = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${data.excel_data}`;
                    const downloadLink = document.createElement("a");
                    downloadLink.href = linkSource;
                    downloadLink.download = data.filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    showNotification('Export successful', 'success');
                } else {
                    showNotification('Export failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('Export error: ' + error.message, 'error');
            });
    }

    // Edit Modal Logic
    let signaturePad = null;
    let signatureType = 'drawn';

    function openEditModal() {
        const modal = document.getElementById('edit-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        
        // Initialize signature pad if not already done
        if (!signaturePad) {
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 3,
                throttle: 16
            });
            
            // Handle window resize
            window.addEventListener('resize', resizeSignatureCanvas);
            resizeSignatureCanvas();
        } else {
            signaturePad.clear();
        }
        
        // Populate remarks from all pages
        let allRemarks = [];
        Object.values(pagesData).forEach(page => {
            if (page.extracted_text && page.extracted_text !== 'No handwritten remarks detected on this page') {
                allRemarks.push(`• Page ${page.page_number}: ${page.extracted_text}`);
            }
        });
        
        document.getElementById('edited-remarks').value = allRemarks.join('\n');
        
        // Set current date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('signature-date').value = today;
        
        // Reset signature preview
        updateFinalSignaturePreview();
        
        // Set default tab
        switchSignatureTab('drawn');
        
        // Clear any previous values
        document.getElementById('signer-name').value = '';
        document.getElementById('signer-role').value = '';
        document.getElementById('typed-signature').value = '';
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('upload-preview-img').src = '#';
    }

    function closeEditModal() {
        const modal = document.getElementById('edit-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = 'auto';
    }

    function resizeSignatureCanvas() {
        const canvas = document.getElementById('signature-pad');
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        
        if (signaturePad) {
            signaturePad.clear();
        }
    }

    function clearSignature() {
        if (signatureType === 'drawn' && signaturePad) {
            signaturePad.clear();
        } else if (signatureType === 'uploaded') {
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('signature-upload').value = '';
            document.getElementById('upload-preview-img').src = '#';
        } else if (signatureType === 'typed') {
            document.getElementById('typed-signature').value = '';
            document.getElementById('typed-preview').textContent = 'Your signature will appear here';
        }
        updateFinalSignaturePreview();
    }

    function undoSignature() {
        if (signatureType === 'drawn' && signatureHistory.length > 0 && currentHistoryIndex > 0) {
            currentHistoryIndex--;
            signaturePad.clear();
            signaturePad.fromData(signatureHistory[currentHistoryIndex]);
            updateFinalSignaturePreview();
        }
    }

    function switchSignatureTab(type) {
        signatureType = type;
        
        // Update UI
        ['drawn', 'uploaded', 'typed'].forEach(t => {
            document.getElementById(`tab-${t}`).classList.remove('text-indigo-600', 'border-indigo-500');
            document.getElementById(`tab-${t}`).classList.add('text-gray-500', 'border-transparent');
            document.getElementById(`content-${t}`).classList.add('hidden');
        });
        
        document.getElementById(`tab-${type}`).classList.remove('text-gray-500', 'border-transparent');
        document.getElementById(`tab-${type}`).classList.add('text-indigo-600', 'border-indigo-500');
        document.getElementById(`content-${type}`).classList.remove('hidden');
        
        if (type === 'drawn') {
            resizeSignatureCanvas();
        }
        
        updateFinalSignaturePreview();
    }

    function handleSignatureUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB');
                return;
            }
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/svg+xml', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a valid image file (JPEG, PNG, SVG, GIF)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('upload-preview-img');
                img.src = e.target.result;
                document.getElementById('upload-preview').classList.remove('hidden');
                updateFinalSignaturePreview();
            };
            reader.readAsDataURL(file);
        }
    }

    function updateTypedPreview() {
        const text = document.getElementById('typed-signature').value;
        const preview = document.getElementById('typed-preview');
        preview.textContent = text || 'Your signature will appear here';
        updateFinalSignaturePreview();
    }

    function updateFinalSignaturePreview() {
        const preview = document.getElementById('final-signature-preview');
        let previewHTML = '';
        
        if (signatureType === 'drawn' && signaturePad && !signaturePad.isEmpty()) {
            previewHTML = `<img src="${signaturePad.toDataURL()}" class="h-10 w-auto" alt="Signature Preview">`;
        } else if (signatureType === 'uploaded') {
            const img = document.getElementById('upload-preview-img');
            if (img && img.src && img.src !== '#') {
                previewHTML = `<img src="${img.src}" class="h-10 w-auto rounded" alt="Signature Preview">`;
            }
        } else if (signatureType === 'typed') {
            const text = document.getElementById('typed-signature').value;
            if (text) {
                previewHTML = `<div class="text-2xl" style="font-family: 'Dancing Script', cursive;">${text}</div>`;
            }
        }
        
        if (previewHTML) {
            preview.innerHTML = previewHTML;
        } else {
            preview.innerHTML = '<p class="text-xs text-gray-400">No signature yet</p>';
        }
    }

    function toggleRemarksFormat() {
        const options = document.getElementById('remarks-format-options');
        options.classList.toggle('hidden');
    }

    function applyRemarksFormat(format) {
        const textarea = document.getElementById('edited-remarks');
        let text = textarea.value;
        
        switch(format) {
            case 'bullets':
                text = text.split('\n').filter(line => line.trim()).map(line => `• ${line}`).join('\n');
                break;
            case 'numbered':
                text = text.split('\n').filter(line => line.trim()).map((line, index) => `${index + 1}. ${line}`).join('\n');
                break;
            case 'paragraph':
                text = text.replace(/[•\d+\.]\s*/g, '').replace(/\n+/g, ' ').trim();
                break;
        }
        
        textarea.value = text;
    }

    function clearRemarks() {
        if (confirm('Are you sure you want to clear all remarks?')) {
            document.getElementById('edited-remarks').value = '';
        }
    }

    async function saveEdits() {
        const signerName = document.getElementById('signer-name').value.trim();
        const signerRole = document.getElementById('signer-role').value.trim();
        const signatureDate = document.getElementById('signature-date').value;
        
        if (!signerName) {
            showNotification('Please enter your name as the inspector', 'error');
            return;
        }
        
        if (!signatureDate) {
            showNotification('Please select a signature date', 'error');
            return;
        }
        
        let signatureData = null;
        let hasValidSignature = false;
        
        if (signatureType === 'drawn') {
            if (signaturePad && !signaturePad.isEmpty()) {
                signatureData = signaturePad.toDataURL();
                hasValidSignature = true;
            } else {
                showNotification('Please draw your signature', 'error');
                return;
            }
        } else if (signatureType === 'uploaded') {
            const img = document.getElementById('upload-preview-img');
            if (img && img.src && img.src !== '#') {
                signatureData = img.src;
                hasValidSignature = true;
            } else {
                showNotification('Please upload a signature image', 'error');
                return;
            }
        } else if (signatureType === 'typed') {
            const typed = document.getElementById('typed-signature').value.trim();
            if (typed) {
                // Convert text to image
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // Background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Signature text
                ctx.font = '40px "Dancing Script", cursive';
                ctx.fillStyle = '#1f2937';
                ctx.textBaseline = 'middle';
                ctx.textAlign = 'center';
                
                // Add text
                ctx.fillText(typed, canvas.width / 2, canvas.height / 2);
                
                signatureData = canvas.toDataURL();
                hasValidSignature = true;
            } else {
                showNotification('Please type your signature', 'error');
                return;
            }
        }
        
        if (!hasValidSignature) {
            showNotification('Please provide a valid signature', 'error');
            return;
        }
        
        const editedRemarks = document.getElementById('edited-remarks').value;
        
        // Disable button and show loading
        const saveBtn = document.getElementById('save-edits-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        
        try {
            const response = await fetch(`/api/file/{{ file.file_id }}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    signature_data: signatureData,
                    signature_type: signatureType,
                    signer_name: signerName,
                    signer_role: signerRole,
                    signature_date: signatureDate,
                    edited_remarks: editedRemarks,
                    original_remarks: ''
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Report finalized and signed successfully!', 'success');
                // Reset the form
                closeEditModal();
                // Optionally refresh the page or update UI
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showNotification('Error saving report: ' + (data.message || 'Unknown error'), 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Error saving edits:', error);
            showNotification('Network error: ' + error.message, 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    // Add event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Close modal buttons
        document.getElementById('close-modal-btn').addEventListener('click', closeEditModal);
        document.getElementById('cancel-modal-btn').addEventListener('click', closeEditModal);
        document.getElementById('save-edits-btn').addEventListener('click', saveEdits);
        
        // Typed signature input event
        document.getElementById('typed-signature').addEventListener('input', updateTypedPreview);
        
        // File upload event
        document.getElementById('signature-upload').addEventListener('change', function(e) {
            handleSignatureUpload(e.target);
        });
        
        // Close modal when clicking outside
        document.getElementById('edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !document.getElementById('edit-modal').classList.contains('hidden')) {
                closeEditModal();
            }
        });
    });
</script>

<!-- Edit Modal -->
<!-- Professional Edit Modal -->
<div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white z-10 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-xl font-bold text-gray-800">Finalize Inspection Report</h3>
            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6 space-y-8">
            <!-- Report Summary -->
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                <h4 class="font-semibold text-blue-800 mb-2">Report Summary</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div>
                        <p class="text-gray-500">File</p>
                        <p class="font-medium">{{ file.file_name }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Total Pages</p>
                        <p class="font-medium">{{ file.total_pages }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Pages with Remarks</p>
                        <p class="font-medium text-orange-600">{{ file.pages_with_remarks }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Criticality</p>
                        <p class="font-medium {{ 'text-red-600' if file.criticality_level == 'RED' else 'text-orange-600' if file.criticality_level == 'ORANGE' else 'text-green-600' }}">
                            {{ file.criticality_level }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Consolidated Remarks -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-sm font-semibold text-gray-700">Consolidated Inspection Remarks</label>
                    <button type="button" onclick="toggleRemarksFormat()" 
                            class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">
                        <i class="fas fa-edit mr-1"></i>Format Options
                    </button>
                </div>
                <div id="remarks-format-options" class="hidden mb-3 p-3 bg-gray-50 rounded-lg border">
                    <div class="flex space-x-3">
                        <button type="button" onclick="applyRemarksFormat('bullets')" 
                                class="text-xs px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50">
                            <i class="fas fa-list-ul mr-1"></i>Bullets
                        </button>
                        <button type="button" onclick="applyRemarksFormat('numbered')" 
                                class="text-xs px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50">
                            <i class="fas fa-list-ol mr-1"></i>Numbered
                        </button>
                        <button type="button" onclick="applyRemarksFormat('paragraph')" 
                                class="text-xs px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50">
                            <i class="fas fa-paragraph mr-1"></i>Paragraph
                        </button>
                        <button type="button" onclick="clearRemarks()" 
                                class="text-xs px-3 py-1 bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100">
                            <i class="fas fa-trash-alt mr-1"></i>Clear All
                        </button>
                    </div>
                </div>
                <textarea id="edited-remarks" rows="8"
                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 font-sans text-sm p-4 border"
                    placeholder="Compile all inspection remarks here..."></textarea>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    You can edit and format the extracted remarks for the final report
                </p>
            </div>

            <!-- Professional Signature Section -->
            <div class="border-2 border-gray-200 rounded-xl p-5 bg-gradient-to-br from-gray-50 to-white">
                <div class="flex items-center mb-6">
                    <div class="bg-indigo-100 p-2 rounded-lg mr-3">
                        <i class="fas fa-signature text-indigo-600 text-lg"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">Authorization & Sign-off</h4>
                        <p class="text-sm text-gray-600">Please provide your signature to authorize this inspection report</p>
                    </div>
                </div>

                <!-- Signer Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Inspector Name <span class="text-red-500">*</span></label>
                        <input type="text" id="signer-name" placeholder="Enter full name"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title/Role</label>
                        <input type="text" id="signer-role" placeholder="e.g., Senior Inspector"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>

                <!-- Signature Tabs -->
                <div class="mb-4">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button id="tab-drawn" onclick="switchSignatureTab('drawn')"
                                class="px-1 py-3 text-sm font-medium border-b-2 transition-all duration-200 text-indigo-600 border-indigo-500 flex items-center">
                                <i class="fas fa-pen-fancy mr-2"></i>Draw Signature
                            </button>
                            <button id="tab-uploaded" onclick="switchSignatureTab('uploaded')"
                                class="px-1 py-3 text-sm font-medium border-b-2 transition-all duration-200 text-gray-500 hover:text-gray-700 border-transparent hover:border-gray-300 flex items-center">
                                <i class="fas fa-upload mr-2"></i>Upload Signature
                            </button>
                            <button id="tab-typed" onclick="switchSignatureTab('typed')"
                                class="px-1 py-3 text-sm font-medium border-b-2 transition-all duration-200 text-gray-500 hover:text-gray-700 border-transparent hover:border-gray-300 flex items-center">
                                <i class="fas fa-font mr-2"></i>Type Signature
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Draw Signature Content -->
                <div id="content-drawn" class="space-y-4">
                    <div class="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300">
                        <canvas id="signature-pad" 
                                class="w-full h-48 bg-white rounded cursor-crosshair touch-none"></canvas>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-lightbulb mr-1"></i>
                            Draw your signature in the box above
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" onclick="clearSignature()"
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm font-medium">
                                <i class="fas fa-redo mr-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upload Signature Content -->
                <div id="content-uploaded" class="hidden space-y-4">
                    <div class="bg-white p-6 rounded-lg border-2 border-dashed border-gray-300 text-center">
                        <div class="max-w-xs mx-auto">
                            <input type="file" id="signature-upload" accept="image/*" 
                                   class="hidden">
                            <label for="signature-upload" 
                                   class="cursor-pointer flex flex-col items-center justify-center p-8">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-file-upload text-blue-600 text-2xl"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 mb-2">Upload Signature Image</span>
                                <span class="text-xs text-gray-500">PNG, JPG or SVG (Max 2MB)</span>
                            </label>
                        </div>
                    </div>
                    <div id="upload-preview" class="hidden">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div class="flex items-center">
                                <img id="upload-preview-img" src="#" alt="Signature Preview" 
                                     class="h-12 w-auto mr-3 rounded">
                                <div>
                                    <p class="text-sm font-medium text-gray-800">Signature Preview</p>
                                    <p class="text-xs text-gray-500">Ready to use</p>
                                </div>
                            </div>
                            <button type="button" onclick="clearSignature()"
                                class="text-red-600 hover:text-red-800 text-sm font-medium">
                                <i class="fas fa-times mr-1"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Type Signature Content -->
                <div id="content-typed" class="hidden space-y-4">
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <input type="text" id="typed-signature" placeholder="Type your full name here"
                            class="w-full text-xl border-0 focus:ring-0 focus:outline-none text-center py-3"
                            style="font-family: 'Dancing Script', cursive;">
                    </div>
                    <div class="border-2 border-gray-200 rounded-lg p-6 bg-white text-center">
                        <p class="text-xs text-gray-400 mb-2 uppercase tracking-wider">Signature Preview</p>
                        <div id="typed-preview" class="text-5xl text-gray-800 min-h-24 flex items-center justify-center"
                            style="font-family: 'Dancing Script', cursive;">
                            Your signature will appear here
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                This will be your official signature
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Signature Preview & Date -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex flex-col md:flex-row md:items-center justify-between space-y-4 md:space-y-0">
                        <div class="text-sm">
                            <p class="font-medium text-gray-700">Date of Authorization</p>
                            <input type="date" id="signature-date" 
                                   class="mt-1 border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div class="text-sm">
                            <p class="font-medium text-gray-700 mb-1">Final Signature Preview</p>
                            <div id="final-signature-preview" class="h-12 w-48 bg-gray-50 border border-dashed border-gray-300 rounded flex items-center justify-center">
                                <p class="text-xs text-gray-400">No signature yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    </div>
                    <div class="ml-3">
                        <h5 class="text-sm font-medium text-yellow-800">Authorization Terms</h5>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p class="mb-2">By signing this report, you confirm that:</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>All inspection remarks have been reviewed and verified</li>
                                <li>The information provided is accurate to the best of your knowledge</li>
                                <li>You have the authority to authorize this inspection report</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4 flex justify-between items-center rounded-b-xl">
            <div class="text-sm text-gray-500">
                <i class="fas fa-lock mr-1"></i>
                This report will be digitally signed and timestamped
            </div>
            <div class="flex space-x-3">
                <button id="cancel-modal-btn" type="button"
                    class="px-5 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="save-edits-btn" type="button"
                    class="px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-lg hover:from-indigo-700 hover:to-indigo-800 font-medium shadow-md transition flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Sign & Finalize Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Signature Pad Library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<!-- Add Google Font for Typed Signature -->
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">

<style>
    .scrollbar-thin::-webkit-scrollbar {
        height: 4px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 2px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 2px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .page-thumbnail {
        transition: all 0.2s ease-in-out;
    }

    .signature-canvas {
        background-image: 
            linear-gradient(to right, #f0f0f0 1px, transparent 1px),
            linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
        background-size: 20px 20px;
    }
    
    .tab-active {
        background: linear-gradient(to bottom right, #4F46E5, #7C3AED);
        color: white;
        border-color: #4F46E5;
    }
    
    .tab-inactive {
        color: #6B7280;
        border-color: #D1D5DB;
    }
    
    .signature-preview {
        border: 2px dashed #D1D5DB;
        transition: all 0.3s ease;
    }
    
    .signature-preview:hover {
        border-color: #4F46E5;
        background-color: #F5F3FF;
    }
    
    /* Smooth transitions */
    .modal-transition {
        transition: all 0.3s ease-in-out;
    }
    
    /* Signature pad responsive */
    @media (max-width: 768px) {
        #signature-pad {
            height: 200px !important;
        }
    }
    
    /* Loading animation */
    .loading-spinner {
        display: inline-block;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}
